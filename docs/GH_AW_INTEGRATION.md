# GitHub Agentic Workflows (gh-aw) Integration Plan

> **Status**: In Progress (Phase 1 Complete)  
> **Date Started**: 2026-02-15  
> **Last Updated**: 2026-02-15  
> **Scope**: Integrating [GitHub Agentic Workflows](https://github.com/github/gh-aw) (gh-aw) into the Rhiza template framework

## Progress Summary

- ✅ **Phase 1**: CLI install + Makefile targets (`gh-aw.mk`) — [308e991](https://github.com/Jebel-Quant/rhiza/commit/308e991)
- ⏳ **Phase 2**: Template bundle definition — Next
- ⏳ **Phase 3**: Starter workflow templates
- ⏳ **Phase 4**: CI validation workflow
- ⏳ **Phase 5**: Secrets setup + engine config
- ⏳ **Phase 6**: Documentation

---

## 1. Executive Summary

GitHub Agentic Workflows (gh-aw) enables writing AI-driven automation in natural language Markdown, compiled into GitHub Actions workflows. Rhiza is a living template system that continuously synchronises configuration into downstream Python projects. Integrating gh-aw into Rhiza means **every downstream project** can opt in to agentic workflows via a single template bundle, following the same conventions used for CI, Docker, testing, etc.

---

## 2. What is gh-aw?

| Concept | Description |
|---------|-------------|
| **Workflow files** | Markdown files (`.md`) in `.github/workflows/` containing YAML frontmatter (triggers, permissions, tools, engine) and natural language instructions |
| **Lock files** | Compiled GitHub Actions YAML (`.lock.yml`) generated by `gh aw compile` |
| **Engines** | AI coding agents — Copilot (default), Claude, or Codex — that interpret the natural language instructions |
| **Safe outputs** | Pre-approved write actions (create issues, post comments, open PRs) that bypass the need for direct write permissions |
| **Safe inputs** | Custom inline MCP tools defined in frontmatter for controlled secret access |
| **Sandbox** | Agent Workflow Firewall (AWF) — mandatory network egress controls, tool allowlists, and input sanitisation |
| **CLI** | `gh aw` extension — `compile`, `run`, `add-wizard`, `init`, `status`, `secrets`, `logs` |

---

## 3. Integration Touchpoints with Rhiza

### 3.1 Natural Alignment

| Rhiza Component | gh-aw Equivalent | Alignment |
|-----------------|-------------------|-----------|
| `.rhiza/make.d/agentic.mk` | `gh aw` CLI commands | Rhiza already has `make copilot`, `make claude` — extend with `make gh-aw-*` targets |
| `.github/agents/` | gh-aw workflow `.md` files | Both live in `.github/`; agents are for interactive CLI, gh-aw is for Actions automation |
| `.github/workflows/` | gh-aw `.md` + `.lock.yml` | gh-aw workflows coexist alongside existing `rhiza_*.yml` workflows |
| `.github/copilot-instructions.md` | gh-aw `imports:` / engine config | Copilot instructions apply to the Copilot engine when used by gh-aw |
| `.github/hooks/` | gh-aw `steps:` / `post-steps:` | Session hooks remain for Copilot coding agent; gh-aw uses its own lifecycle |
| Template bundles | gh-aw `gh aw add-wizard` | Rhiza distributes templates; gh-aw distributes workflows. Complementary. |
| `Makefile` hook system | gh-aw `compile` / `run` | Make targets wrap gh-aw CLI commands |

### 3.2 Key Differences

- **Rhiza workflows** (e.g. `rhiza_ci.yml`) are traditional GitHub Actions — deterministic, pre-programmed steps.
- **gh-aw workflows** are _agentic_ — AI interprets natural language and makes context-dependent decisions.
- Both coexist in `.github/workflows/`; gh-aw files are identified by the `.md` + `.lock.yml` pair.

---

## 4. Implementation Plan

### Phase 1: Foundation (CLI & Makefile Integration)

#### 4.1.1 Install gh-aw CLI target

Add to `.rhiza/make.d/agentic.mk`:

```makefile
GH_AW_BIN ?= $(shell gh extension list 2>/dev/null | grep -q gh-aw && echo "gh aw" || echo "")

install-gh-aw: require-gh ## install the gh-aw CLI extension
	@if gh extension list 2>/dev/null | grep -q gh-aw; then \
	  printf "$${GREEN}[INFO] gh-aw extension already installed.${RESET}\n"; \
	else \
	  printf "$${BLUE}[INFO] Installing gh-aw extension...${RESET}\n"; \
	  gh extension install github/gh-aw; \
	  printf "$${GREEN}[INFO] gh-aw extension installed.${RESET}\n"; \
	fi
```

#### 4.1.2 Core gh-aw Make targets

```makefile
##@ GitHub Agentic Workflows (gh-aw)

gh-aw-compile: install-gh-aw ## compile all agentic workflow .md files to .lock.yml
	@gh aw compile

gh-aw-compile-strict: install-gh-aw ## compile with strict security validation
	@gh aw compile --strict

gh-aw-status: install-gh-aw ## show status of all agentic workflows
	@gh aw status

gh-aw-run: install-gh-aw ## run a specific agentic workflow (usage: make gh-aw-run WORKFLOW=<name>)
	@if [ -z "$(WORKFLOW)" ]; then \
	  printf "$${RED}[ERROR] Specify WORKFLOW=<name>. Example: make gh-aw-run WORKFLOW=daily-repo-status${RESET}\n"; \
	  exit 1; \
	fi
	@gh aw run $(WORKFLOW)

gh-aw-init: install-gh-aw ## initialise repository for gh-aw (adds .vscode, prompts, settings)
	@gh aw init

gh-aw-secrets: install-gh-aw ## bootstrap/check gh-aw secrets
	@gh aw secrets bootstrap

gh-aw-logs: install-gh-aw ## show logs for recent agentic workflow runs
	@gh aw logs
```

#### 4.1.3 Validation integration

Add a pre-commit or CI step to validate that `.md` and `.lock.yml` files are in sync:

```makefile
gh-aw-validate: install-gh-aw ## validate lock files are up-to-date
	@gh aw compile --check
```

This should be called from a Rhiza CI workflow or as an optional hook.

---

### Phase 2: Template Bundle

#### 4.2.1 New `gh-aw` bundle in `template-bundles.yml`

```yaml
  # ============================================================================
  # GH-AW - GitHub Agentic Workflows
  # ============================================================================
  gh-aw:
    description: "GitHub Agentic Workflows for AI-driven repository automation"
    standalone: true
    requires: [github]
    recommends: [tests]
    notes: |
      Provides infrastructure for gh-aw (GitHub Agentic Workflows):
      - Makefile targets for compile/run/status
      - Starter workflow templates
      - CI validation for lock file freshness
      - Documentation
    files:
      # Makefile extensions (added to agentic.mk or separate file)
      - .rhiza/make.d/gh-aw.mk

      # Starter agentic workflows
      - .github/workflows/daily-repo-status.md

      # CI validation workflow
      - .github/workflows/rhiza_gh-aw-validate.yml

      # Documentation
      - docs/GH_AW.md
```

#### 4.2.2 Separation of concerns

Rather than mixing gh-aw targets into the existing `agentic.mk` (which handles local CLI agents), create a dedicated `.rhiza/make.d/gh-aw.mk` for all gh-aw targets. This keeps the bundles cleanly separable:

| File | Purpose |
|------|---------|
| `agentic.mk` | Local interactive agents (Copilot CLI, Claude Code) |
| `gh-aw.mk` | GitHub Agentic Workflows (Actions-based automation) |

---

### Phase 3: Starter Workflows

Provide curated, Rhiza-aware agentic workflow templates that downstream projects get automatically.

#### 4.3.1 Daily Repository Status Report

`.github/workflows/daily-repo-status.md`:

```markdown
---
on:
  schedule:
    - cron: "0 9 * * 1-5"  # Weekdays at 09:00 UTC
  workflow_dispatch:

description: "Daily status report for the repository"

engine: copilot

permissions:
  issues: read
  contents: read
  pull-requests: read

tools:
  github:
    toolsets: [repos, issues, pull_requests]

safe-outputs:
  create-issue:
    title: "Daily Status Report — {{ date }}"
    labels: ["report", "automated"]

network:
  allowed:
    - defaults
    - python
---

# Daily Repository Status Report

Analyze the current state of this repository and produce a concise status report.

## What to include

- **Open issues**: Count and highlight any critical/blocking issues
- **Open PRs**: Count, age, and any stale PRs (>7 days without activity)
- **Recent CI status**: Summary of recent workflow runs (pass/fail trends)
- **Recent releases**: Most recent release tag and date
- **Test coverage**: If available, report current coverage percentage
- **Dependencies**: Note any outdated or flagged dependencies

## Style

- Be concise and factual
- Use tables where appropriate
- Highlight action items clearly
- Max 500 words

## Process

1. Read repository metadata, issues, and PRs
2. Check recent workflow run status
3. Compile findings into a structured report
4. Create an issue with the report
```

#### 4.3.2 CI Doctor (Fix Failing Builds)

`.github/workflows/ci-doctor.md`:

```markdown
---
on:
  workflow_run:
    workflows: ["*"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

if: github.event.workflow_run.conclusion == 'failure'

description: "Diagnose and suggest fixes for failing CI workflows"

engine: copilot

permissions:
  contents: read
  actions: read
  issues: read

tools:
  github:
    toolsets: [repos, issues, actions]
  bash: ["make test", "make fmt", "uv run pytest"]

safe-outputs:
  create-issue:
    title: "CI Doctor: {{ workflow_name }} failure diagnosis"
    labels: ["ci", "automated", "needs-attention"]

network:
  allowed:
    - defaults
    - python
---

# CI Failure Diagnosis

A CI workflow has failed on the main branch. Diagnose the failure and suggest fixes.

## Instructions

1. Identify which workflow failed and on which commit
2. Read the workflow logs to understand the failure
3. Check if the failure is:
   - A test failure (examine test output)
   - A lint/format issue (check ruff output)
   - A dependency issue (check uv/pip output)
   - An infrastructure issue (runner, network, etc.)
4. If possible, identify the root cause commit
5. Suggest a concrete fix

## Rhiza project context

This is a Rhiza-based Python project. Key commands:
- `make test` — run pytest with coverage
- `make fmt` — run ruff format + check
- `make deptry` — check dependencies
- `uv run pytest` — run tests via uv

## Output

Create an issue with:
- **Workflow**: Name and run URL
- **Failure type**: Classification
- **Root cause**: What went wrong
- **Suggested fix**: Concrete steps or code changes
- **Severity**: Critical / Warning / Info
```

#### 4.3.3 Issue Triage

`.github/workflows/issue-triage.md`:

```markdown
---
on:
  issues:
    types: [opened]

description: "Automatically triage new issues with labels and initial response"

engine: copilot

permissions:
  issues: read
  contents: read

tools:
  github:
    toolsets: [issues, repos]

safe-outputs:
  add-issue-comment:
  add-issue-labels:
    labels: ["bug", "enhancement", "question", "documentation", "good first issue"]

network:
  allowed:
    - defaults
---

# Issue Triage

A new issue has been opened: #${{ github.event.issue.number }}

## Instructions

1. Read the issue title and body
2. Classify the issue type:
   - **bug**: Something is broken or not working as expected
   - **enhancement**: A feature request or improvement
   - **question**: A question about usage or behaviour
   - **documentation**: Documentation improvement needed
   - **good first issue**: Simple enough for new contributors
3. Apply appropriate label(s)
4. Post a helpful initial comment acknowledging the issue and providing relevant context

## Guidelines

- Be welcoming and helpful
- If it's a bug, ask for reproduction steps if not provided
- If it's a question, point to relevant documentation in `docs/`
- If it's an enhancement, acknowledge and note it for maintainer review
- Never close issues automatically
```

---

### Phase 4: CI/CD Validation Workflow

#### 4.4.1 Lock file freshness check

`.github/workflows/rhiza_gh-aw-validate.yml`:

```yaml
name: "Validate Agentic Workflows"

on:
  pull_request:
    paths:
      - ".github/workflows/*.md"
  push:
    branches: [main]
    paths:
      - ".github/workflows/*.md"

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install gh CLI
        uses: cli/cli-action@v1

      - name: Install gh-aw extension
        run: gh extension install github/gh-aw
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate lock files are up-to-date
        run: |
          gh aw compile
          if ! git diff --quiet .github/workflows/*.lock.yml; then
            echo "::error::Agentic workflow lock files are out of date. Run 'gh aw compile' and commit the changes."
            git diff .github/workflows/*.lock.yml
            exit 1
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

---

### Phase 5: Secrets & Authentication Setup

#### 4.5.1 Engine secret configuration

Add a `make gh-aw-setup` target that guides users through secret configuration:

```makefile
gh-aw-setup: install-gh-aw ## guided setup for gh-aw secrets and engine configuration
	@printf "$${BLUE}[INFO] Setting up GitHub Agentic Workflows...${RESET}\n"
	@printf "$${BLUE}Which AI engine will you use?${RESET}\n"
	@printf "  1) Copilot (requires COPILOT_GITHUB_TOKEN)\n"
	@printf "  2) Claude  (requires ANTHROPIC_API_KEY)\n"
	@printf "  3) Codex   (requires OPENAI_API_KEY)\n"
	@printf "$${BLUE}Choice [1]: ${RESET}"; \
	read -r choice; \
	case "$${choice:-1}" in \
	  1) gh aw secrets set COPILOT_GITHUB_TOKEN ;; \
	  2) gh aw secrets set ANTHROPIC_API_KEY ;; \
	  3) gh aw secrets set OPENAI_API_KEY ;; \
	  *) printf "$${RED}Invalid choice.${RESET}\n"; exit 1 ;; \
	esac
	@gh aw secrets bootstrap
	@printf "$${GREEN}[INFO] Setup complete. Run 'make gh-aw-status' to verify.${RESET}\n"
```

#### 4.5.2 Engine selection in Makefile

Allow downstream projects to set a default engine in their root `Makefile`:

```makefile
# Root Makefile (downstream project)
GH_AW_ENGINE ?= copilot  # or: claude, codex
```

The starter workflow templates would use `engine: copilot` by default. The documentation should explain how to change this per-workflow via the `engine:` frontmatter field.

---

### Phase 6: Documentation

#### 4.6.1 Rhiza documentation (`docs/GH_AW.md`)

Contents:
- What is gh-aw and why use it with Rhiza
- Prerequisites (gh CLI, AI account)
- Quick start: `make install && make gh-aw-init`
- Available Make targets reference table
- How to add/create/customise workflows
- Security considerations and guardrails
- Engine configuration (Copilot / Claude / Codex)
- Secrets setup guide
- Troubleshooting
- Links to upstream gh-aw documentation

#### 4.6.2 Update copilot-instructions.md

Add gh-aw context to `.github/copilot-instructions.md`:

```markdown
### GitHub Agentic Workflows (gh-aw)

This repository uses GitHub Agentic Workflows for AI-driven automation.
Agentic workflow files are Markdown files in `.github/workflows/` with
`.lock.yml` compiled counterparts.

- **Compile workflows**: `make gh-aw-compile` or `gh aw compile`
- **Run a workflow**: `make gh-aw-run WORKFLOW=<name>` or `gh aw run <name>`
- **Check status**: `make gh-aw-status`
- **Never edit `.lock.yml` files directly** — edit the `.md` source and recompile
```

#### 4.6.3 Update `docs/QUICK_REFERENCE.md`

Add gh-aw targets to the quick reference card.

---

## 5. File Manifest

Summary of all new/modified files:

| File | Action | Bundle |
|------|--------|--------|
| `.rhiza/make.d/gh-aw.mk` | **Create** | gh-aw |
| `.rhiza/template-bundles.yml` | **Modify** (add gh-aw bundle) | core |
| `.github/workflows/daily-repo-status.md` | **Create** | gh-aw |
| `.github/workflows/ci-doctor.md` | **Create** | gh-aw |
| `.github/workflows/issue-triage.md` | **Create** | gh-aw |
| `.github/workflows/rhiza_gh-aw-validate.yml` | **Create** | gh-aw |
| `docs/GH_AW.md` | **Create** | gh-aw |
| `docs/GH_AW_INTEGRATION.md` | **Remove** (this planning doc, replaced by GH_AW.md) | — |
| `.github/copilot-instructions.md` | **Modify** (add gh-aw section) | github |
| `docs/QUICK_REFERENCE.md` | **Modify** (add gh-aw targets) | core |

---

## 6. Downstream Usage

Once the bundle is available, downstream projects opt in via `.rhiza/template.yml`:

```yaml
repository: Jebel-Quant/rhiza
ref: v0.9.0  # version that includes gh-aw bundle
templates:
  - core
  - github
  - tests
  - gh-aw    # ← opt in to agentic workflows
```

After `make sync`, the downstream project receives:
1. `gh-aw.mk` with all Make targets
2. Starter workflow templates (daily-repo-status, ci-doctor, issue-triage)
3. The CI validation workflow for lock file freshness
4. Documentation

The developer then runs:
```bash
make gh-aw-setup    # Configure secrets for their chosen engine
make gh-aw-compile  # Compile .md → .lock.yml
git add .github/workflows/*.md .github/workflows/*.lock.yml
git commit -m "Add agentic workflows"
git push
```

---

## 7. Security Considerations

| Concern | Mitigation |
|---------|------------|
| **Write permissions** | All starter workflows use `safe-outputs` instead of direct write permissions |
| **Network egress** | Workflows specify explicit `network.allowed` lists; AWF sandbox is mandatory |
| **Prompt injection** | gh-aw sanitises inputs; `safe-inputs` for any user-facing tools |
| **Secret exposure** | Secrets accessed only through GitHub Actions secrets; never in workflow Markdown |
| **Lock file tampering** | CI validation workflow ensures `.lock.yml` matches compiled `.md` source |
| **Engine cost control** | `timeout-minutes` set on all workflows; `stop-after` available for scheduled workflows |
| **Role gating** | Default `roles: [admin, maintainer, write]` on all event-triggered workflows |

---

## 8. Phased Rollout Timeline

| Phase | Scope | Effort | Status | Commit |
|-------|-------|--------|--------|--------|
| **Phase 1** | CLI install + Makefile targets (`gh-aw.mk`) | 1–2 hours | ✅ **COMPLETE** | [308e991](https://github.com/Jebel-Quant/rhiza/commit/308e991) |
| **Phase 2** | Template bundle definition | 30 min | ⏳ Pending | — |
| **Phase 3** | Starter workflow templates (3 workflows) | 2–3 hours | ⏳ Pending | — |
| **Phase 4** | CI validation workflow | 30 min | ⏳ Pending | — |
| **Phase 5** | Secrets setup + engine config | 1 hour | ⏳ Pending | — |
| **Phase 6** | Documentation (GH_AW.md, copilot-instructions, quick ref) | 1–2 hours | ⏳ Pending | — |
| **Total** | | **~6–9 hours** | **Phase 1 complete** | — |

---

## 9. Future Extensions

- **Template gallery**: Curate a catalogue of gh-aw workflow templates for common Python project tasks (release notes generation, dependency update summaries, stale issue cleanup, PR review assistance)
- **`gh aw add-wizard` integration**: A `make gh-aw-add` target that wraps `gh aw add-wizard` for adding community workflows
- **Python-specific workflows**: Workflows aware of `pyproject.toml`, `uv`, pytest, ruff — leveraging Rhiza conventions
- **Multi-engine support**: Allow downstream `Makefile` to set per-workflow engine overrides
- **Monitoring dashboard**: A `make gh-aw-dashboard` target that summarises recent agentic run outcomes, costs, and durations
- **GitLab parity**: Investigate whether gh-aw concepts can be adapted for the existing Rhiza GitLab bundle

---

## 10. References

- [gh-aw README](https://github.com/github/gh-aw)
- [Quick Start Guide](https://github.github.com/gh-aw/setup/quick-start/)
- [Creating Workflows](https://github.github.com/gh-aw/setup/creating-workflows/)
- [Workflow Structure](https://github.github.com/gh-aw/reference/workflow-structure/)
- [Frontmatter Reference](https://github.github.com/gh-aw/reference/frontmatter/)
- [AI Engines](https://github.github.com/gh-aw/reference/engines/)
- [Authorization](https://github.github.com/gh-aw/reference/auth/)
- [Security Architecture](https://github.github.com/gh-aw/introduction/architecture/)
- [Peli's Agent Factory](https://github.github.com/gh-aw/blog/2026-01-12-welcome-to-pelis-agent-factory/)
