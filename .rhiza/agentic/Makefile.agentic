## Makefile.agentic - User-defined scripts and overrides for agentic workflows
# This file is included by the main Makefile

# Declare phony targets
.PHONY: install-copilot analyse-repo summarize-changes copilot

# Copilot binary location - check global first, fall back to local bin
COPILOT_BIN ?= $(shell command -v copilot 2>/dev/null || echo ${INSTALL_DIR}/copilot)

##@ Agentic Workflows

copilot: install-copilot ## open interactive prompt for copilot
	@${COPILOT_BIN} --model "${DEFAULT_AI_MODEL}"

analyse-repo: install-copilot ## run the analyser agent to update REPOSITORY_ANALYSIS.md
	@${COPILOT_BIN} --agent analyser \
		--model "${DEFAULT_AI_MODEL}" \
		--prompt "Analyze the repository and update the journal." \
    --allow-tool 'write' --deny-tool 'remove' \
		--allow-all-paths

summarize-changes: install-copilot ## summarize changes since the most recent release/tag
	@${COPILOT_BIN} -p "Show me the commits since the last release/tag and summarize them" --allow-tool 'shell(git)' --model "${DEFAULT_AI_MODEL}" --agent summarise

install-copilot:  ## ensure copilot CLI is installed
	@mkdir -p "${INSTALL_DIR}"
	@if command -v copilot >/dev/null 2>&1; then \
		printf "${GREEN}[INFO] GitHub Copilot CLI is installed globally.${RESET}\n"; \
	elif [ -x "${INSTALL_DIR}/copilot" ]; then \
		printf "${GREEN}[INFO] GitHub Copilot CLI is already installed in ${INSTALL_DIR}.${RESET}\n"; \
	else \
		printf "${YELLOW}[WARN] GitHub Copilot CLI not found.${RESET}\n"; \
		printf "${BLUE}Do you want to install GitHub Copilot CLI to ${INSTALL_DIR}? [y/N] ${RESET}"; \
		read -r response; \
		if [ "$$response" = "y" ] || [ "$$response" = "Y" ]; then \
			printf "${BLUE}[INFO] Installing GitHub Copilot CLI to ${INSTALL_DIR}...${RESET}\n"; \
			if curl -fsSL https://gh.io/copilot-install | PREFIX="." bash; then \
				printf "${GREEN}[INFO] GitHub Copilot CLI installed successfully.${RESET}\n"; \
			else \
				printf "${RED}[ERROR] Failed to install GitHub Copilot CLI.${RESET}\n"; \
				exit 1; \
			fi; \
		else \
			printf "${BLUE}[INFO] Skipping installation.${RESET}\n"; \
		fi; \
	fi

