# This file is part of the jebel-quant/rhiza repository
# (https://github.com/jebel-quant/rhiza).
#
# Dependency Update Dry-Run Checks
#
# This workflow validates dependency updates before they are applied:
# - Runs on a weekly schedule (same as Renovate)
# - Can be triggered manually for ad-hoc checks
# - Reports available updates without applying them
# - Validates that updates don't break the lock file resolution

name: (RHIZA) DEPS-CHECK

on:
  schedule:
    # Run weekly on Mondays at 06:00 UTC (before Renovate at 10am Dubai = 06:00 UTC)
    - cron: '0 6 * * 1'
  workflow_dispatch:
    inputs:
      package:
        description: 'Specific package to check (leave empty for all)'
        required: false
        type: string

permissions:
  contents: read

jobs:
  check-updates:
    name: Check for Updates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "0.9.26"

      - name: Check for outdated packages
        id: outdated
        run: |
          echo "## ðŸ“¦ Dependency Update Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Sync environment first
          uv sync --all-extras --all-groups --frozen

          # Check for outdated packages
          echo "### Outdated Packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          uv pip list --outdated 2>&1 | tee outdated.txt >> $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY

          # Count outdated packages
          OUTDATED_COUNT=$(grep -c "^[a-zA-Z]" outdated.txt 2>/dev/null || echo "0")
          if [ "$OUTDATED_COUNT" -gt "1" ]; then
            # Subtract 1 for header line
            OUTDATED_COUNT=$((OUTDATED_COUNT - 1))
          fi
          echo "outdated_count=$OUTDATED_COUNT" >> $GITHUB_OUTPUT

      - name: Dry-run lock upgrade
        id: dry_run
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Lock File Upgrade (Dry Run)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Perform dry-run upgrade
          if [ -n "${{ inputs.package }}" ]; then
            echo "Checking specific package: ${{ inputs.package }}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            uv lock --upgrade-package "${{ inputs.package }}" --dry-run 2>&1 | tee upgrade.txt >> $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "Checking all packages..." >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            uv lock --upgrade --dry-run 2>&1 | tee upgrade.txt >> $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          # Check for resolution issues
          if grep -qi "error\|conflict\|failed" upgrade.txt; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Warning:** Potential resolution issues detected" >> $GITHUB_STEP_SUMMARY
            echo "resolution_ok=false" >> $GITHUB_OUTPUT
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Lock file resolution successful" >> $GITHUB_STEP_SUMMARY
            echo "resolution_ok=true" >> $GITHUB_OUTPUT
          fi

      - name: Validate lock file
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Lock File Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Verify current lock file is valid
          if uv sync --all-extras --all-groups --frozen --dry-run 2>&1; then
            echo "âœ… Current lock file is valid and frozen sync succeeds" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Lock file validation failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Actions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Renovate** will automatically create PRs for updates (Tuesdays before 10am Dubai)" >> $GITHUB_STEP_SUMMARY
          echo "- **Manual upgrade**: Run \`uv lock --upgrade\` locally" >> $GITHUB_STEP_SUMMARY
          echo "- **Single package**: Run \`uv lock --upgrade-package <name>\`" >> $GITHUB_STEP_SUMMARY
