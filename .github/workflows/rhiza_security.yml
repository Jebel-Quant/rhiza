# This file is part of the jebel-quant/rhiza repository
# (https://github.com/jebel-quant/rhiza).
#
# Workflow: Security
#
# Purpose: This workflow runs security scans on the project including:
#          - pip-audit: Check for known vulnerabilities in dependencies
#          - bandit: Static analysis for common security issues in Python code
#
# Trigger: This workflow runs on every push and on pull requests to main/master
#          branches (including from forks)

name: "(RHIZA) SECURITY"

# Permissions: Only read access to repository contents is needed
permissions:
    contents: read

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  security:
    name: Security scanning
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/astral-sh/uv:0.9.28-bookworm

    steps:
      - uses: actions/checkout@v6.0.2

      - name: Configure git for private GitHub repos
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          if [ -n "$GH_PAT" ]; then
            git config --global url."https://${GH_PAT}@github.com/".insteadOf "https://github.com/"
            echo "âœ… Git configured for private GitHub repositories"
          fi

      - name: Run security scans
        env:
          UV_EXTRA_INDEX_URL: ${{ secrets.UV_EXTRA_INDEX_URL }}
        run: make security


      - name: Run typecheck
        env:
          UV_EXTRA_INDEX_URL: ${{ secrets.UV_EXTRA_INDEX_URL }}
        run: make typecheck
