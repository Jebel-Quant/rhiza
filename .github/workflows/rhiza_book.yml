# This file is part of the jebel-quant/rhiza repository
# (https://github.com/jebel-quant/rhiza).
#
# Workflow: Book
# Purpose: This workflow builds and deploys comprehensive documentation for the project.
#          It combines API documentation, test coverage reports, test results, and
#          interactive notebooks into a single GitHub Pages site.
#
# Trigger: This workflow runs on every push to the main or master branch
#
# Components:
#   - ðŸ““ Process Marimo notebooks
#   - ðŸ“– Generate API documentation with pdoc
#   - ðŸ§ª Run tests and generate coverage reports
#   - ðŸš€ Deploy combined documentation to GitHub Pages
#
# Custom Environment Variables for Marimo Notebooks:
#   This workflow supports passing custom environment variables to notebooks during build.
#
#   Recommended approach (no workflow modification needed):
#     1. Create a .env.marimo file in your repository root
#     2. Add KEY=value pairs (one per line)
#     3. The workflow automatically sources this file before building
#     4. Access variables in notebooks: os.environ.get('KEY')
#
#   Alternative approach (requires workflow modification):
#     1. Define secrets/vars in GitHub Settings > Secrets and variables > Actions
#     2. Uncomment env: section in "Make the book" step and add your variables
#     3. Reference them: ${{ secrets.YOUR_SECRET }} or ${{ vars.YOUR_VAR }}
#
#   Note: .env.marimo is gitignored and won't be overwritten by template sync

name: "(RHIZA) BOOK"

on:
  push:
    branches:
      - main
      - master

jobs:
  book:
    runs-on: "ubuntu-latest"

    environment:
      name: github-pages  # ðŸ‘ˆ this is the critical missing piece

    permissions:
      contents: read
      pages: write            # Permission to deploy to Pages
      id-token: write         # Permission to verify deployment origin

    steps:
      # Check out the repository code
      - uses: actions/checkout@v6
        with:
          lfs: true

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "0.9.26"

      - name: "Sync the virtual environment for ${{ github.repository }}"
        shell: bash
        run: |
          export UV_EXTRA_INDEX_URL="${{ secrets.uv-extra-index-url }}"
          # will just use .python-version?
          uv sync --all-extras --all-groups --frozen

      - name: "Make the book"
        # To pass custom environment variables/secrets to notebooks during build:
        #
        # Option 1 (Recommended): Use .env.marimo file (not synced by template)
        #   - Create .env.marimo in your repository root with KEY=value pairs
        #   - This file is gitignored and won't be overwritten by template sync
        #   - Variables are automatically loaded before the book build
        #
        # Option 2: Define directly in workflow (requires modifying this file)
        #   - Uncomment the env: section below and add your variables
        #   - Define secrets/vars in GitHub Settings > Secrets and variables > Actions
        #   - Access them in notebooks with: os.environ.get('VAR_NAME')
        #
        # Example .env.marimo:
        #   API_KEY=my-api-key-from-secret
        #   DATABASE_URL=postgresql://localhost/mydb
        #
        # Example env: section:
        # env:
        #   API_KEY: ${{ secrets.MARIMO_ENV_API_KEY }}
        #   DATABASE_URL: ${{ vars.MARIMO_ENV_DATABASE_URL }}
        run: |
          # Source .env.marimo if it exists (for custom env vars)
          if [ -f .env.marimo ]; then
            echo "Loading environment variables from .env.marimo"
            # Basic validation: check for dangerous shell patterns before sourcing
            if grep -qE '(\$\(|`|&&|\|\||;|\|[^|])' .env.marimo 2>/dev/null; then
              echo "ERROR: .env.marimo contains potentially unsafe shell syntax"
              echo "Please use only simple KEY=value pairs (one per line)"
              exit 1
            fi
            set -a
            source .env.marimo
            set +a
          fi
          make -f .rhiza/rhiza.mk book

      # Step 5: Package all artifacts for GitHub Pages deployment
      # This prepares the combined outputs for deployment by creating a single artifact
      - name: Upload static files as artifact
        uses: actions/upload-pages-artifact@v4  # Official GitHub Pages artifact upload action
        with:
          path: _book/  # Path to the directory containing all artifacts to deploy

      # Step 6: Deploy the packaged artifacts to GitHub Pages
      # This step publishes the content to GitHub Pages
      # The deployment is conditional based on whether the repository is a fork and the PUBLISH_COMPANION_BOOK variable is set
      # If the repository is a fork, deployment is skipped to avoid unauthorised publishing
      # If PUBLISH_COMPANION_BOOK is not set, it defaults to allowing deployment
      - name: Deploy to GitHub Pages
        if: ${{ !github.event.repository.fork && (vars.PUBLISH_COMPANION_BOOK == 'true' || vars.PUBLISH_COMPANION_BOOK == '') }}
        uses: actions/deploy-pages@v4  # Official GitHub Pages deployment action
        continue-on-error: true
