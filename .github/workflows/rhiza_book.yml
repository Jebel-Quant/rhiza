# This file is part of the jebel-quant/rhiza repository
# (https://github.com/jebel-quant/rhiza).
#
# Workflow: Book
# Purpose: This workflow builds and deploys comprehensive documentation for the project.
#          It combines API documentation, test coverage reports, test results, and
#          interactive notebooks into a single GitHub Pages site.
#
# Trigger: This workflow runs on every push to the main or master branch
#
# Components:
#   - ðŸ““ Process Marimo notebooks
#   - ðŸ“– Generate API documentation with pdoc
#   - ðŸ§ª Run tests and generate coverage reports
#   - ðŸš€ Deploy combined documentation to GitHub Pages
#
# Custom Environment Variables for Marimo Notebooks:
#   This workflow supports passing custom environment variables and secrets to
#   Marimo notebooks without requiring you to modify this file.
#
#   To use this feature:
#   1. Go to Settings > Secrets and variables > Actions
#   2. Add secrets or variables with MARIMO_ENV_ prefix:
#      - For secrets: MARIMO_ENV_VAR_1, MARIMO_ENV_VAR_2, etc.
#      - For variables: MARIMO_ENV_VAR_1, MARIMO_ENV_VAR_2, etc.
#   3. They will be available in notebooks as ENV_VAR_1, ENV_VAR_2, etc.
#   4. Access them in notebooks with: os.environ.get('ENV_VAR_1')
#
#   20 generic variable slots (ENV_VAR_1 through ENV_VAR_20) are available.
#   Each can be either a secret or a regular variable.
#   Use them for any purpose: API keys, database URLs, feature flags, etc.
#
#   Example usage:
#   - Define MARIMO_ENV_VAR_1 as secret containing your API key
#   - Define MARIMO_ENV_VAR_2 as variable containing database URL
#   - In notebook: api_key = os.environ.get('ENV_VAR_1')
#   - In notebook: db_url = os.environ.get('ENV_VAR_2')

name: "(RHIZA) BOOK"

on:
  push:
    branches:
      - main
      - master

jobs:
  book:
    runs-on: "ubuntu-latest"

    environment:
      name: github-pages  # ðŸ‘ˆ this is the critical missing piece

    permissions:
      contents: read
      pages: write            # Permission to deploy to Pages
      id-token: write         # Permission to verify deployment origin

    steps:
      # Check out the repository code
      - uses: actions/checkout@v6
        with:
          lfs: true

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "0.9.26"

      - name: "Sync the virtual environment for ${{ github.repository }}"
        shell: bash
        run: |
          export UV_EXTRA_INDEX_URL="${{ secrets.uv-extra-index-url }}"
          # will just use .python-version?
          uv sync --all-extras --all-groups --frozen

      - name: "Make the book"
        env:
          # Custom environment variables for Marimo notebooks
          # Define secrets/vars in your repository settings with MARIMO_ENV_ prefix
          # They will be available to notebooks without the prefix
          # Example: MARIMO_ENV_API_KEY â†’ API_KEY, MARIMO_ENV_DATABASE_URL â†’ DATABASE_URL
          #
          # Generic variables (use for any purpose - secrets, config, feature flags, etc.):
          ENV_VAR_1: ${{ secrets.MARIMO_ENV_VAR_1 || vars.MARIMO_ENV_VAR_1 }}
          ENV_VAR_2: ${{ secrets.MARIMO_ENV_VAR_2 || vars.MARIMO_ENV_VAR_2 }}
          ENV_VAR_3: ${{ secrets.MARIMO_ENV_VAR_3 || vars.MARIMO_ENV_VAR_3 }}
          ENV_VAR_4: ${{ secrets.MARIMO_ENV_VAR_4 || vars.MARIMO_ENV_VAR_4 }}
          ENV_VAR_5: ${{ secrets.MARIMO_ENV_VAR_5 || vars.MARIMO_ENV_VAR_5 }}
          ENV_VAR_6: ${{ secrets.MARIMO_ENV_VAR_6 || vars.MARIMO_ENV_VAR_6 }}
          ENV_VAR_7: ${{ secrets.MARIMO_ENV_VAR_7 || vars.MARIMO_ENV_VAR_7 }}
          ENV_VAR_8: ${{ secrets.MARIMO_ENV_VAR_8 || vars.MARIMO_ENV_VAR_8 }}
          ENV_VAR_9: ${{ secrets.MARIMO_ENV_VAR_9 || vars.MARIMO_ENV_VAR_9 }}
          ENV_VAR_10: ${{ secrets.MARIMO_ENV_VAR_10 || vars.MARIMO_ENV_VAR_10 }}
          ENV_VAR_11: ${{ secrets.MARIMO_ENV_VAR_11 || vars.MARIMO_ENV_VAR_11 }}
          ENV_VAR_12: ${{ secrets.MARIMO_ENV_VAR_12 || vars.MARIMO_ENV_VAR_12 }}
          ENV_VAR_13: ${{ secrets.MARIMO_ENV_VAR_13 || vars.MARIMO_ENV_VAR_13 }}
          ENV_VAR_14: ${{ secrets.MARIMO_ENV_VAR_14 || vars.MARIMO_ENV_VAR_14 }}
          ENV_VAR_15: ${{ secrets.MARIMO_ENV_VAR_15 || vars.MARIMO_ENV_VAR_15 }}
          ENV_VAR_16: ${{ secrets.MARIMO_ENV_VAR_16 || vars.MARIMO_ENV_VAR_16 }}
          ENV_VAR_17: ${{ secrets.MARIMO_ENV_VAR_17 || vars.MARIMO_ENV_VAR_17 }}
          ENV_VAR_18: ${{ secrets.MARIMO_ENV_VAR_18 || vars.MARIMO_ENV_VAR_18 }}
          ENV_VAR_19: ${{ secrets.MARIMO_ENV_VAR_19 || vars.MARIMO_ENV_VAR_19 }}
          ENV_VAR_20: ${{ secrets.MARIMO_ENV_VAR_20 || vars.MARIMO_ENV_VAR_20 }}
        run: |
          make -f .rhiza/rhiza.mk book

      # Step 5: Package all artifacts for GitHub Pages deployment
      # This prepares the combined outputs for deployment by creating a single artifact
      - name: Upload static files as artifact
        uses: actions/upload-pages-artifact@v4  # Official GitHub Pages artifact upload action
        with:
          path: _book/  # Path to the directory containing all artifacts to deploy

      # Step 6: Deploy the packaged artifacts to GitHub Pages
      # This step publishes the content to GitHub Pages
      # The deployment is conditional based on whether the repository is a fork and the PUBLISH_COMPANION_BOOK variable is set
      # If the repository is a fork, deployment is skipped to avoid unauthorised publishing
      # If PUBLISH_COMPANION_BOOK is not set, it defaults to allowing deployment
      - name: Deploy to GitHub Pages
        if: ${{ !github.event.repository.fork && (vars.PUBLISH_COMPANION_BOOK == 'true' || vars.PUBLISH_COMPANION_BOOK == '') }}
        uses: actions/deploy-pages@v4  # Official GitHub Pages deployment action
        continue-on-error: true
