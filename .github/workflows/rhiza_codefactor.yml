# This file is part of the jebel-quant/rhiza repository
# (https://github.com/jebel-quant/rhiza).
#
# Workflow: CodeFactor Status Check
#
# Purpose: Verify that CodeFactor is working and code quality meets standards.
#
# Trigger: On push and pull requests to main/master branches.

name: (RHIZA) CODEFACTOR

permissions:
  contents: read

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  check-codefactor:
    runs-on: ubuntu-latest
    steps:
      - name: Check CodeFactor status
        id: codefactor
        run: |
          # Fetch CodeFactor badge
          RESPONSE=$(curl -sL -w "\n%{http_code}" "https://www.codefactor.io/repository/github/jebel-quant/rhiza/badge")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP Status Code: $HTTP_CODE"

          # Check if badge is accessible
          if [ "$HTTP_CODE" != "200" ]; then
            echo "❌ CodeFactor badge is not accessible (HTTP $HTTP_CODE)"
            echo "This could mean:"
            echo "  - CodeFactor service is down"
            echo "  - Repository is not connected to CodeFactor"
            echo "  - Badge endpoint has changed"
            exit 1
          fi

          # Verify it's actually an SVG (basic check)
          if ! echo "$BODY" | grep -q "<svg"; then
            echo "❌ CodeFactor badge did not return valid SVG"
            exit 1
          fi

          echo "✅ CodeFactor badge is accessible"

          # Extract grade from SVG badge
          # The grade appears in <text> elements in the SVG
          GRADE=$(echo "$BODY" | sed -n 's/.*textLength="170">\([^<]*\)<.*/\1/p' | head -n1 || echo "unknown")

          if [ "$GRADE" = "unknown" ]; then
            echo "⚠️  Could not parse grade from badge"
            exit 1
          fi

          echo "Current CodeFactor Grade: $GRADE"
          echo "grade=$GRADE" >> $GITHUB_OUTPUT

          # Optional: Fail if grade is below threshold
          # Uncomment and adjust the threshold as needed:
          # ACCEPTABLE_GRADES=("A+" "A" "A-" "B+")
          # if [[ ! " ${ACCEPTABLE_GRADES[@]} " =~ " ${GRADE} " ]]; then
          #   echo "❌ Code quality grade ($GRADE) is below acceptable threshold"
          #   exit 1
          # fi

          echo "✅ CodeFactor check passed"

      - name: Display CodeFactor status
        run: |
          echo "CodeFactor is functioning properly"
          echo "Grade: ${{ steps.codefactor.outputs.grade }}"
          echo "View detailed report: https://www.codefactor.io/repository/github/jebel-quant/rhiza"
