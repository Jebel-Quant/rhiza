# This file is part of the jebel-quant/rhiza repository
# (https://github.com/jebel-quant/rhiza).
#
# Workflow: Coverage Badge
#
# Purpose: Generate and publish coverage badge JSON for use in documentation and README.
#          This badge reflects the test coverage percentage and is color-coded based on coverage level.
#
# Trigger: On push to main/master branches (after tests complete).

name: "(RHIZA) COVERAGE BADGE"

on:
  push:
    branches:
      - main
      - master

jobs:
  coverage-badge:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # Permission to push badge artifact

    steps:
      # Check out the repository code
      - uses: actions/checkout@v6.0.2
        with:
          lfs: true

      - name: Install uv
        uses: astral-sh/setup-uv@v7.3.0
        with:
          version: "0.10.0"

      - name: Configure git auth for private packages
        uses: ./.github/actions/configure-git-auth
        with:
          token: ${{ secrets.GH_PAT }}

      - name: "Sync the virtual environment for ${{ github.repository }}"
        shell: bash
        env:
          UV_EXTRA_INDEX_URL: ${{ secrets.UV_EXTRA_INDEX_URL }}
        run: |
          uv sync --all-extras --all-groups --frozen

      - name: "Run tests to generate coverage data"
        env:
          UV_EXTRA_INDEX_URL: ${{ secrets.UV_EXTRA_INDEX_URL }}
        run: |
          make test

      - name: "Generate coverage badge JSON"
        run: |
          if [ -f "_tests/coverage.json" ]; then
            echo "Generating coverage badge JSON..."
            mkdir -p _badge
            uv run python -c "
import json
data = json.load(open('_tests/coverage.json'))
pct = int(data['totals']['percent_covered'])
color = 'brightgreen' if pct >= 90 else 'green' if pct >= 80 else 'yellow' if pct >= 70 else 'orange' if pct >= 60 else 'red'
badge = {'schemaVersion': 1, 'label': 'coverage', 'message': f'{pct}%', 'color': color}
json.dump(badge, open('_badge/coverage-badge.json', 'w'))
"
            echo "Coverage badge JSON generated:"
            cat _badge/coverage-badge.json
          else
            echo "Error: No coverage.json found"
            exit 1
          fi

      - name: Upload coverage badge artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-badge
          path: _badge/coverage-badge.json
          retention-days: 90
