# This file is part of the jebel-quant/rhiza repository
# (https://github.com/jebel-quant/rhiza).
#
# Workflow: Deptry
#
# Purpose: This workflow identifies missing and obsolete dependencies in the project.
#          It helps maintain a clean dependency tree by detecting unused packages and
#          implicit dependencies that should be explicitly declared.
#
# Trigger: This workflow runs on every push and on pull requests to main/master
#          branches (including from forks)

name: "(RHIZA) DEPTRY"

# Permissions: Only read access to repository contents is needed
permissions:
    contents: read

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  deptry:
    name: Check dependencies with deptry
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/astral-sh/uv:0.9.30-bookworm

    steps:
      - uses: actions/checkout@v6.0.2

      - name: Configure git auth for private packages
        uses: ./.github/actions/configure-git-auth
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Extract folder variables
        id: folders
        run: |
          # Extract SOURCE_FOLDER from the project configuration (via Makefile)
          # shellcheck disable=SC2016 # Single quotes intentional - Make syntax, not shell expansion
          SOURCE_FOLDER=$(make -s -f Makefile -f - <<< 'print: ; @echo $(or $(SOURCE_FOLDER),src)' print)
          echo "source=$SOURCE_FOLDER" >> "$GITHUB_OUTPUT"
          
          # Extract MARIMO_FOLDER from the project configuration (via Makefile)
          # shellcheck disable=SC2016 # Single quotes intentional - Make syntax, not shell expansion
          MARIMO_FOLDER=$(make -s -f Makefile -f - <<< 'print: ; @echo $(or $(MARIMO_FOLDER),marimo)' print)
          echo "marimo=$MARIMO_FOLDER" >> "$GITHUB_OUTPUT"
          
          echo "Detected SOURCE_FOLDER: $SOURCE_FOLDER"
          echo "Detected MARIMO_FOLDER: $MARIMO_FOLDER"

      - name: Run deptry on source folder
        if: steps.folders.outputs.source != ''
        run: |
          if [ -d "${{ steps.folders.outputs.source }}" ]; then
            uvx -p $(cat .python-version 2>/dev/null || echo "3.13") deptry "${{ steps.folders.outputs.source }}"
          else
            echo "Source folder ${{ steps.folders.outputs.source }} does not exist, skipping"
          fi

      - name: Run deptry on marimo folder
        if: steps.folders.outputs.marimo != ''
        run: |
          if [ -d "${{ steps.folders.outputs.marimo }}" ]; then
            if [ -d "${{ steps.folders.outputs.source }}" ]; then
              uvx -p $(cat .python-version 2>/dev/null || echo "3.13") deptry "${{ steps.folders.outputs.marimo }}" "${{ steps.folders.outputs.source }}" --ignore DEP004
            else
              uvx -p $(cat .python-version 2>/dev/null || echo "3.13") deptry "${{ steps.folders.outputs.marimo }}" --ignore DEP004
            fi
          else
            echo "Marimo folder ${{ steps.folders.outputs.marimo }} does not exist, skipping"
          fi
